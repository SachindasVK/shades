<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Wallet - SHADES</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Playfair+Display:wght@700&display=swap"
        rel="stylesheet">
    <style>
        .page-body {
            background-color: #f3f4f6;
        }

        .containeer {
            max-width: 95%;
            margin-left: auto;
            margin-right: auto;
            display: flex;
            gap: 2rem;
            padding: 10px;
        }

        .sidebar {
            width: 20rem;
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            height: fit-content;
        }

        .profile-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .profile-icon {
            width: 3rem;
            height: 3rem;
            background-color: #a1a1a1;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .profile-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 9999px;
        }

        .greeting {
            color: #6b7280;
            font-size: 0.875rem;
        }

        .username {
            color: #1f2937;
            font-weight: 600;
        }

        .menu-link {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            color: #4b5563;
            font-size: 0.875rem;
        }

        .menu-link:hover {
            background-color: #f9fafb;
        }

        .menu-link.active {
            background-color: #eff6ff;
            color: #2563eb;
        }

        .menu-icon {
            width: 1.25rem;
            margin-right: 0.75rem;
        }

        .logout-link {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            color: #dc2626;
            font-size: 0.875rem;
        }

        .logout-link:hover {
            background-color: #fef2f2;
        }

        .main-content {
            flex: 1;
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 2rem;
        }

        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1.5rem;
        }

        .wallet-balance {
            background: linear-gradient(135deg, #1a1a1a 0%, #333333 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .balance-amount {
            font-size: 2rem;
            font-weight: 700;
        }

        .limit-note {
            font-size: 0.875rem;
            color: #d1d5db;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }

        .btn-primary {
            background-color: #ffffff;
            color: #1f2937;
            border: 1px solid #d1d5db;
        }

        .btn-primary:hover {
            background-color: #f3f4f6;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .modal-header {
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
        }

        .modal-message {
            font-size: 1rem;
            color: #374151;
            margin-bottom: 1rem;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        .btn-secondary {
            background-color: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover {
            background-color: #e5e7eb;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-success {
            background-color: #22c55e;
            color: white;
        }

        .badge-reward {
            background-color: #2563eb;
            color: white;
        }

        .badge-failed {
            background-color: #ef4444;
            color: white;
        }

        .badge-pending {
            background-color: #f59e0b;
            color: white;
        }

        .transaction-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .transaction-table th,
        .transaction-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .transaction-table th {
            font-weight: 600;
            color: #1f2937;
        }

        .filter-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .filter-group select,
        .filter-group input {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
        }

        .pagination {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1.5rem;
        }

        .pagination button {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background-color: white;
            cursor: pointer;
        }

        .pagination button:disabled {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }

        .stats-card {
            background-color: #008cff4a;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .stats-card h3 {
            font-size: 0.90rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .stats-card p {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            min-width: 250px;
            background-color: #1f2937;
            color: white;
            padding: 1rem;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 2000;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.success {
            background-color: #22c55e;
        }

        .toast.error {
            background-color: #ef4444;
        }

        .shop-header {
            background-color: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
        }

        .transaction-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .transaction-details {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .transaction-icon {
            width: 2rem;
            height: 2rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #22c55e;
            color: white;
        }

        .transaction-date {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .transaction-amount {
            font-weight: 600;
            color: #22c55e;
        }
    </style>
</head>

<body class="page-body">
    <%- include("../../views/partials/user/header") %>
    <div class="shop-header">
        <div class="max-w-7xl mx-auto px-4">
            <nav aria-label="breadcrumb">
                <ol class="flex space-x-2 text-sm">
                    <li><a href="/" class="text-blue-600 hover:underline">Home</a></li>
                    <li><span class="mx-2 text-black">></span><a href="/shop" class="text-blue-600 hover:underline">Shop</a></li>
                    <li><span class="mx-2">></span><span class="text-gray-500">Wallet</span></li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="containeer">
        <div class="sidebar">
            <div class="profile-header">
                <div class="profile-icon">
                   <% if (user.image) { %>
                        <img src="/uploads/userProfileimages/<%= user.image %>" alt="Profile Image" class="profile-image">
                    <% } else { %>
                        <i class="fas fa-user" style="color: #ffffff; font-size: 1.125rem;"></i>
                    <% } %>
                </div>
                <div>
                    <div class="greeting">Hello,</div>
                    <div class="username"><%= user.name %></div>
                </div>
            </div>
            <nav class="menu">
                <ul class="menu-list">
                    <li class="menu-item">
                        <a href="/profile" class="menu-link">
                            <i class="fas fa-user menu-icon"></i> Profile Information
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="/orders" class="menu-link">
                            <i class="fas fa-box menu-icon"></i> My Orders
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="/address" class="menu-link">
                            <i class="fas fa-home menu-icon"></i> Manage Addresses
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="/wallet" class="menu-link active">
                            <i class="fas fa-wallet menu-icon"></i> My Wallet
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="/wishlist" class="menu-link">
                            <i class="fas fa-heart menu-icon"></i> My Wishlist
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="/referals" class="menu-link">
                            <i class="fas fa-users menu-icon"></i> Refer Friends
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="/changepassword" class="menu-link">
                            <i class="fas fa-lock menu-icon"></i> Change Password
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="/logout" class="logout-link">
                            <i class="fas fa-sign-out-alt menu-icon"></i> Log out
                        </a>
                    </li>
                </ul>
            </nav>
        </div>

        <div class="main-content">
            <h2 class="section-title">My Wallet</h2>

            <!-- Wallet Balance and Rewards Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="wallet-balance">
                    <h3 class="section-title text-white">Available Balance</h3>
                    <p class="balance-amount">₹<%= user.wallet ? user.wallet.balance.toLocaleString('en-IN') : '0' %></p>
                    <p class="limit-note">
                        <i class="fas fa-info-circle"></i>
                        You can add up to ₹2.5 lakhs
                    </p>
                    <button class="btn btn-primary mt-4" onclick="openAddMoneyModal()">Add Money</button>
                </div>
                <div class="stats-card">
                    <h3 class="section-title">Rewards</h3>
                    <div>
                        <h3 class="text-sm text-gray-600">Cashback Earned</h3>
                        <p class="text-lg font-semibold">₹0.00</p>
                    </div>
                    <div class="mt-4">
                        <h3 class="text-sm text-gray-600">Total Referrals</h3>
                        <p class="text-lg font-semibold"><%= user.referrals ? user.referrals.length : 0 %></p>
                        <a href="/referals" class="text-blue-600 hover:underline text-sm">View Referral Program</a>
                    </div>
                </div>
            </div>

            <!-- Recent Transactions -->
            <h3 class="section-title">Recent Transactions</h3>
            <div class="filter-group">
                <select id="transactionFilter" onchange="filterTransactions()">
                    <option value="all">All Transactions</option>
                    <option value="added">Money Added</option>
                    <option value="reward">Rewards</option>
                    <option value="used">Used</option>
                </select>
                <button onclick="filterTransactions()" class="btn btn-primary">Apply</button>
            </div>

            <div id="transactionList">
                <% if (transactions && transactions.length > 0) { %>
                    <% transactions.forEach((transaction) => { %>
                        <div class="transaction-item">
                            <div class="transaction-details">
                                <div class="transaction-icon">
                                    <i class="fas fa-arrow-up"></i>
                                </div>
                                <div>
                                    <p class="font-medium">Added via <%= transaction.method %></p>
                                    <p class="transaction-date"><%= new Date(transaction.date).toLocaleDateString('en-IN') %></p>
                                </div>
                            </div>
                            <p class="transaction-amount">+₹<%= transaction.amount.toLocaleString('en-IN') %></p>
                        </div>
                    <% }); %>
                <% } else { %>
                    <p class="text-gray-500 italic text-center">No transactions found</p>
                <% } %>
            </div>

            <!-- Pagination -->
            <div class="pagination">
                <span id="pageInfo">1 of 1</span>
            </div>
        </div>
    </div>

    <!-- Add Money Modal -->
    <div id="addMoneyModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Money to Wallet</h3>
            </div>
            <div class="modal-message">
                <label for="amountInput" class="block text-sm font-medium text-gray-700">Enter Amount</label>
                <input type="number" id="amountInput" class="w-full p-2 border rounded mt-1" placeholder="Enter amount" min="1" max="250000">
                <p class="mt-2 text-sm text-gray-600">Payment Method: Razorpay</p>
            </div>
            <div class="button-group">
                <button type="button" class="btn btn-secondary" onclick="closeAddMoneyModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="proceedToPay()">Proceed to Pay</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <%- include("../../views/partials/user/footer") %>

    <script>
        let currentPage = 1;
        const transactionsPerPage = 10;
        let allTransactions = <%- JSON.stringify(transactions || []) %>;

        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }

        function openAddMoneyModal() {
            document.getElementById('addMoneyModal').classList.remove('hidden');
        }

        function closeAddMoneyModal() {
            document.getElementById('addMoneyModal').classList.add('hidden');
            document.getElementById('amountInput').value = '';
        }

        function proceedToPay() {
            const amount = document.getElementById('amountInput').value;
            if (!amount || amount <= 0 || amount > 250000) {
                showToast('Please enter a valid amount (₹1 - ₹2,50,000)', 'error');
                return;
            }

            fetch('/wallet/add-money', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount: parseFloat(amount) })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Money added successfully!', 'success');
                        document.querySelector('.balance-amount').textContent = `₹${data.newBalance.toLocaleString('en-IN')}`;
                        closeAddMoneyModal();
                        fetchTransactions();
                    } else {
                        showToast(data.message || 'Failed to add money', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('An error occurred. Please try again.', 'error');
                });
        }

        function fetchTransactions() {
            fetch('/wallet/transactions')
                .then(response => response.json())
                .then(data => {
                    allTransactions = data.transactions || [];
                    filterTransactions();
                })
                .catch(error => {
                    console.error('Error fetching transactions:', error);
                    showToast('Failed to load transactions', 'error');
                });
        }

        function filterTransactions() {
            const filter = document.getElementById('transactionFilter').value;

            let filteredTransactions = allTransactions.filter(t => {
                return filter === 'all' || t.type === filter;
            });

            const totalPages = Math.ceil(filteredTransactions.length / transactionsPerPage);
            currentPage = Math.min(currentPage, totalPages || 1);
            const start = (currentPage - 1) * transactionsPerPage;
            const paginatedTransactions = filteredTransactions.slice(start, start + transactionsPerPage);

            const transactionList = document.getElementById('transactionList');
            transactionList.innerHTML = paginatedTransactions.length > 0 ? paginatedTransactions.map(t => `
                <div class="transaction-item">
                    <div class="transaction-details">
                        <div class="transaction-icon">
                            <i class="fas fa-arrow-up"></i>
                        </div>
                        <div>
                            <p class="font-medium">Added via ${t.method}</p>
                            <p class="transaction-date">${new Date(t.date).toLocaleDateString('en-IN')}</p>
                        </div>
                    </div>
                    <p class="transaction-amount">+₹${t.amount.toLocaleString('en-IN')}</p>
                </div>
            `).join('') : '<p class="text-gray-500 italic text-center">No transactions found</p>';

            document.getElementById('pageInfo').textContent = `${currentPage} of ${totalPages || 1}`;
        }

        document.getElementById('addMoneyModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeAddMoneyModal();
            }
        });
    </script>
</body>

</html>