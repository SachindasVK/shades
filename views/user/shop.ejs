<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHADES - Your Store</title>
    <link rel="icon" href="/favicon-16x16.png" type="image/png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script defer src="/script/script.js"></script>
    <link rel="stylesheet" href="/css/user.css">
</head>

<body>
    <%- include("../../views/partials/user/header") %>

        <!-- Shop Header -->
        <div class="shop-header">
            <div class="max-w-7xl mx-auto px-4">
                <nav aria-label="breadcrumb">
                    <ol class="flex space-x-2 text-sm">
                        <li><a href="/" class="text-black hover:underline text-xs"><i class="fas fa-home"></i> Home</a>
                        </li>
                        <li class="flex items-center"><span class="mx-2"><svg
                                    class="h-5 w-5 text-gray-500 rtl:rotate-180" aria-hidden="true"
                                    xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none"
                                    viewBox="0 0 24 24">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                        stroke-width="2" d="m9 5 7 7-7 7"></path>
                                </svg>
                            </span><span class="text-gray-500 text-xs">All</span></li>
                    </ol>
                </nav>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-4 mb-5">
            <!-- Search and Sort Row -->
            <div class="flex flex-wrap -mx-2 mb-4">
                <div class="w-full md:w-8/12 px-2 mb-3 md:mb-0">
                    <form id="searchForm" action="/shop" method="GET">
                        <div class="search-container">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input w-full" id="searchInput" name="search"
                                placeholder="Search for products..." value="<%= filters.search %>">
                            <% if (filters.search) { %>
                                <button type="button" class="search-clear" id="clearSearch">
                                    <i class="fas fa-times"></i>
                                </button>
                                <% } %>
                        </div>
                    </form>
                </div>
                <div class="w-full md:w-3/12 px-2 ml-auto flex justify-end">
                    <div class="relative w-full md:w-48">
                        <i
                            class="fas fa-sort-amount-down absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 pointer-events-none"></i>
                        <select class="sort-select w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm bg-white shadow-sm hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:border-gray-500 transition" name="sort" id="sortSelect">

    <option value="" <%= (!filters.sort || filters.sort === '') ? 'selected disabled' : 'disabled' %>>Sort by</option>

    <option value="new" <%= filters.sort === 'new' ? 'selected' : '' %>>New Arrivals</option>

    <option value="price-asc" <%= filters.sort === 'price-asc' ? 'selected' : '' %>>Price: Low to High</option>

    <option value="price-desc" <%= filters.sort === 'price-desc' ? 'selected' : '' %>>Price: High to Low</option>

    <option value="name-asc" <%= filters.sort === 'name-asc' ? 'selected' : '' %>>Name: A to Z</option>

    <option value="name-desc" <%= filters.sort === 'name-desc' ? 'selected' : '' %>>Name: Z to A</option>

</select>


                    </div>
                </div>
            </div>

            <div class="flex flex-wrap -mx-3">
                <!-- Filter Sidebar -->
                <div class="w-full lg:w-3/12 px-3">
                    <div class="filter-sidebar">
                        <h4>Filter Products</h4>
                        <form id="filterForm" action="/shop" method="GET">
                            <% if (filters.search) { %>
                                <input type="hidden" name="search" value="<%= filters.search %>">
                                <% } %>
                                    <input type="hidden" id="sortInput" name="sort" value="<%= filters.sort %>">
                                    <!-- Category Filter -->
                                    <div class="filter-group">
                                        <h5>Categories</h5>
                                        <div class="form-check">
                                            <input class="form-check-input category-filter" type="checkbox"
                                                name="category" id="categoryAll" value="all"
                                                <%=filters.category.includes('all') ? 'checked' : '' %>>
                                            <label class="form-check-label" for="categoryAll">All Categories</label>
                                        </div>
                                        <% category.forEach(function(cat) { %>
                                            <div class="form-check">
                                                <input class="form-check-input category-filter" type="checkbox"
                                                    name="category" id="category<%= cat._id %>" value="<%= cat._id %>"
                                                    <%=filters.category.includes(cat._id.toString()) ? 'checked' : ''
                                                    %>>
                                                <label class="form-check-label" for="category<%= cat._id %>">
                                                    <%= cat.name %>
                                                </label>
                                            </div>
                                            <% }); %>
                                    </div>
                                    <!-- Price Range Filter -->
                                    <div class="filter-group">
                                        <h5>Price Range</h5>
                                        <div class="price-range-inputs">
                                            <div class="flex items-center">
                                                <span class="text-gray-600 mr-2">₹</span>
                                                <input type="number" class="form-control w-full" id="minPrice"
                                                    name="minPrice" value="<%= filters.minPrice %>"
                                                    min="<%= priceRange.min %>" max="<%= priceRange.max %>"
                                                    placeholder="Min">
                                            </div>
                                            <div class="flex items-center">
                                                <span class="text-gray-600 mr-2">₹</span>
                                                <input type="number" class="form-control w-full" id="maxPrice"
                                                    name="maxPrice" value="<%= filters.maxPrice %>"
                                                    min="<%= priceRange.min %>" max="<%= priceRange.max %>"
                                                    placeholder="Max">
                                            </div>
                                        </div>
                                        <div class="price-slider-values mt-2 flex justify-between">
                                            <small>₹<%= priceRange.min %></small>
                                            <small>₹<%= priceRange.max %></small>
                                        </div>
                                    </div>


                                    <!-- Brand Filter -->
                                    <div class="filter-group">
                                        <h5>Brands</h5>
                                        <div class="form-check">
                                            <input class="form-check-input brand-filter" type="checkbox" name="brand"
                                                id="brandAll" value="all" <%=filters.brand.includes('all') ? 'checked'
                                                : '' %>>
                                            <label class="form-check-label" for="brandAll">All Brands</label>
                                        </div>
                                        <% brand.forEach(function(b) { %>
                                            <div class="form-check">
                                                <input class="form-check-input brand-filter" type="checkbox"
                                                    name="brand" id="brand<%= b._id %>" value="<%= b._id %>"
                                                    <%=filters.brand.includes(b._id.toString()) ? 'checked' : '' %>>
                                                <label class="form-check-label" for="brand<%= b._id %>">
                                                    <%= b.name %>
                                                </label>
                                            </div>
                                            <% }); %>
                                    </div>
                                    <div class="grid gap-2">
                                        <button type="submit" class="btn btn-filter">Apply Filters</button>
                                        <a href="/shop" class="btn btn-reset">Reset All</a>
                                    </div>
                        </form>
                    </div>
                </div>


                <!-- Products Section -->
                <div class="w-full lg:w-9/12 px-3">
                    
                    <% if (products.length===0) { %>
                        <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4">
                            <i class="fas fa-info-circle mr-2"></i>
                            No products found matching your criteria. Try adjusting your filters.
                        </div>
                        <% } else { %>
                            <div class="product-grid mb-4">
                                <% products.forEach(function(product) { %>
                                    <div class="product-card">
                                        <div class="product-img-container">
                                            <% if (product.isNew) { %>
                                                <span class="product-badge">New</span>
                                                <% } else if (product.regularPrice && product.price) { %>
                                                    <% const discount=Math.round((product.regularPrice - product.price)
                                                        / product.regularPrice * 100); %>
                                                        <% if (discount> 0) { %>
                                                            <span class="product-badge">
                                                                <%= discount %>% OFF
                                                            </span>
                                                            <% } %>
                                                                <% } %>
                                                                    <button class="wishlist-btn add-to-wishlist"
                                                                        data-product-id="<%= product._id %>">
                                                                        <i class="far fa-heart"></i>
                                                                    </button>
                                                                    <a href="/product/details/<%= product._id %>">
                                                                        <img src="<%= product.productImage[0] %>"
                                                                            class="product-img"
                                                                            alt="<%= product.name || product.productName %>">
                                                                    </a>
                                        </div>
                                        <div class="card-body">
                                            <a href="/product/details/<%= product._id %>">
                                                <div class="product-category">
                                                </div>
                                                <% if (product.quantity < 6 && product.quantity> 0) { %>
                                                    <div
                                                        class="absolute top-2 left-2 bg-white/30 backdrop-blur-lg text-black text-xs px-2 py-1 rounded-md shadow-md border border-white/60 z-10">
                                                        Only <%= product.quantity %> left!
                                                    </div>
                                                    <% } %>

                                                        <div
                                                            class="product-category text-xs text-gray-500 mb-1 flex justify-between items-center">
                                                            <span>
                                                                <%=product.brand?product.brand.name : 'Eyewear' %>
                                                            </span>
                                                            <div class="text-yellow-500 text-[10px] flex ml-2">
                                                                <i class="fas fa-star mr-[1px]"></i>
                                                                <i class="fas fa-star mr-[1px]"></i>
                                                                <i class="fas fa-star mr-[1px]"></i>
                                                                <i class="fas fa-star mr-[1px]"></i>
                                                                <i class="fas fa-star-half-alt"></i>
                                                            </div>
                                                        </div>
                                                        <h3 class="product-title">
                                                            <%= product.name || product.productName %>
                                                        </h3>
                                                        <% if (product.averageRating) { %>
                                                            <div class="product-rating">
                                                                <span class="rating-stars">
                                                                    <% for(let i=1; i <=5; i++) { %>
                                                                        <% if (i <=Math.floor(product.averageRating)) {
                                                                            %>
                                                                            <i class="fas fa-star"></i>
                                                                            <% } else if (i
                                                                                <=Math.floor(product.averageRating) +
                                                                                0.5) { %>
                                                                                <i class="fas fa-star-half-alt"></i>
                                                                                <% } else { %>
                                                                                    <i class="far fa-star"></i>
                                                                                    <% } %>
                                                                                        <% } %>
                                                                </span>
                                                                <% if (product.ratingCount) { %>
                                                                    <span class="rating-count">(<%= product.ratingCount
                                                                            %>
                                                                            )</span>
                                                                    <% } %>
                                                            </div>
                                                            <% } %>
                                                                <div class="product-price">
                                                                    <span class="current-price">₹<%= (product.price ||
                                                                            product.salePrice).toLocaleString('en-IN')
                                                                            %></span>
                                                                    <% if (product.regularPrice && product.regularPrice>
                                                                        (product.price || product.salePrice)) { %>
                                                                        <span class="original-price">₹<%=
                                                                                product.regularPrice.toLocaleString('en-IN')
                                                                                %>
                                                                        </span>
                                                                        <% const
                                                                            discount=Math.round((product.regularPrice -
                                                                            (product.price || product.salePrice)) /
                                                                            product.regularPrice * 100); %>
                                                                            <span class="discount-percentage">
                                                                                <%= discount %>% off
                                                                            </span>
                                                                            <% } %>
                                                                </div>
                                            </a>
                                        </div>
                                        <div class="card-footer">
                                            <%if(product.quantity===0){%>
                                                <button class="btn btn-add-cart add-to-cart"
                                                    data-product-id="<%= product._id %>" <%=product.quantity===0
                                                    ? 'disabled' : '' %> >
                                                    <i class="fas fa-times-circle mr-2"></i>Out of stock
                                                </button>
                                                <%}else{%>
                                                    <button class="btn btn-add-cart add-to-cart"
                                                        data-product-id="<%= product._id %>">
                                                        <i class="fas fa-shopping-cart"></i> Add to Cart
                                                    </button>
                                                    <%}%>
                                        </div>
                                    </div>
                                    <% }); %>
                            </div>
                            <% } %>
                                <!-- Pagination -->
                                <% if (totalPages> 1) { %>
                                    <div class="pagination-container flex justify-center items-center mt-10">
                                        <nav aria-label="Page navigation">
                                            <ul class="flex items-center space-x-2">
                                                <!-- Previous Button -->
                                                <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                                                    <a class="page-link" href="#" data-page="<%= currentPage - 1 %>"
                                                        aria-label="Previous" <%=currentPage===1
                                                        ? 'aria-disabled="true"' : '' %>>
                                                        <i class="fas fa-chevron-left"></i>
                                                    </a>
                                                </li>
                                                <!-- Page Numbers -->
                                                <% const maxVisiblePages=5; let startPage=Math.max(1, currentPage -
                                                    Math.floor(maxVisiblePages / 2)); let endPage=Math.min(totalPages,
                                                    startPage + maxVisiblePages - 1); if (endPage - startPage + 1 <
                                                    maxVisiblePages) { startPage=Math.max(1, endPage - maxVisiblePages +
                                                    1); } %>
                                                    <% if (startPage> 1) { %>
                                                        <li class="page-item">
                                                            <a class="page-link" href="#" data-page="1">1</a>
                                                        </li>
                                                        <% if (startPage> 2) { %>
                                                            <li class="page-item">
                                                                <span class="page-link">...</span>
                                                            </li>
                                                            <% } %>
                                                                <% } %>
                                                                    <% for (let i=startPage; i <=endPage; i++) { %>
                                                                        <li
                                                                            class="page-item <%= currentPage === i ? 'active' : '' %>">
                                                                            <a class="page-link" href="#"
                                                                                data-page="<%= i %>" <%=currentPage===i
                                                                                ? 'aria-current="page"' : '' %>>
                                                                                <%= i %>
                                                                            </a>
                                                                        </li>
                                                                        <% } %>
                                                                            <% if (endPage < totalPages) { %>
                                                                                <% if (endPage < totalPages - 1) { %>
                                                                                    <li class="page-item">
                                                                                        <span
                                                                                            class="page-link">...</span>
                                                                                    </li>
                                                                                    <% } %>
                                                                                        <li class="page-item">
                                                                                            <a class="page-link"
                                                                                                href="#"
                                                                                                data-page="<%= totalPages %>">
                                                                                                <%= totalPages %>
                                                                                            </a>
                                                                                        </li>
                                                                                        <% } %>
                                                                                            <!-- Next Button -->
                                                                                            <li
                                                                                                class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                                                                                                <a class="page-link"
                                                                                                    href="#"
                                                                                                    data-page="<%= currentPage + 1 %>"
                                                                                                    aria-label="Next"
                                                                                                    <%=currentPage===totalPages
                                                                                                    ? 'aria-disabled="true"'
                                                                                                    : '' %>>
                                                                                                    <i
                                                                                                        class="fas fa-chevron-right"></i>
                                                                                                </a>
                                                                                            </li>
                                            </ul>
                                        </nav>
                                    </div>
                                    <% } %>
                </div>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                initializeCartButtons();
                initializeWishlistButtons();

                // Sort handling
                const sortSelect = document.getElementById('sortSelect');
                sortSelect.addEventListener('change', function () {
                    const queryString = buildQueryString(1);
                    const params = new URLSearchParams(queryString);

                    // Only set sort parameter if a valid option is selected
                    if (this.value && this.value !== '') {
                        params.set('sort', this.value);
                    } else {
                        params.delete('sort'); // Remove sort parameter if "Sort by" is selected
                    }

                    window.location.href = `/shop?${params.toString()}`;
                });

                // Search handling
                const clearSearchBtn = document.getElementById('clearSearch');
                if (clearSearchBtn) {
                    clearSearchBtn.addEventListener('click', function () {
                        document.getElementById('searchInput').value = '';
                        document.getElementById('searchForm').submit();
                    });
                }

                const searchInput = document.getElementById('searchInput');
                searchInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        document.getElementById('searchForm').submit();
                    }
                });

                // Category and Brand filter handling
                const categoryAll = document.getElementById('categoryAll');
                const brandAll = document.getElementById('brandAll');
                const categoryCheckboxes = document.querySelectorAll('.category-filter:not(#categoryAll)');
                const brandCheckboxes = document.querySelectorAll('.brand-filter:not(#brandAll)');

                categoryAll.addEventListener('change', function () {
                    if (this.checked) {
                        categoryCheckboxes.forEach(cb => cb.checked = false);
                    }
                });

                brandAll.addEventListener('change', function () {
                    if (this.checked) {
                        brandCheckboxes.forEach(cb => cb.checked = false);
                    }
                });

                categoryCheckboxes.forEach(cb => {
                    cb.addEventListener('change', function () {
                        if (this.checked) {
                            categoryAll.checked = false;
                        }
                    });
                });

                brandCheckboxes.forEach(cb => {
                    cb.addEventListener('change', function () {
                        if (this.checked) {
                            brandAll.checked = false;
                        }
                    });
                });

                // Build query string with all filter parameters
                function buildQueryString(page) {
                    const params = new URLSearchParams(window.location.search);
                    params.set('page', page);

                    // Ensure sort parameter is included
                    if (sortSelect.value && sortSelect.value !== 'sort by') {
                        params.set('sort', sortSelect.value);
                    }

                    // Preserve search input
                    if (searchInput.value) {
                        params.set('search', searchInput.value);
                    }

                    // Preserve category filters
                    const categoryCheckboxes = document.querySelectorAll('.category-filter:checked:not(#categoryAll)');
                    const categories = Array.from(categoryCheckboxes).map(cb => cb.value);
                    if (categories.length > 0) {
                        params.set('category', categories.join(','));
                    } else if (document.getElementById('categoryAll').checked) {
                        params.set('category', 'all');
                    }

                    // Preserve brand filters
                    const brandCheckboxes = document.querySelectorAll('.brand-filter:checked:not(#brandAll)');
                    const brands = Array.from(brandCheckboxes).map(cb => cb.value);
                    if (brands.length > 0) {
                        params.set('brand', brands.join(','));
                    } else if (document.getElementById('brandAll').checked) {
                        params.set('brand', 'all');
                    }

                    // Preserve price range
                    const minPrice = document.getElementById('minPrice').value;
                    const maxPrice = document.getElementById('maxPrice').value;
                    if (minPrice) params.set('minPrice', minPrice);
                    if (maxPrice) params.set('maxPrice', maxPrice);

                    return params.toString();
                }

                // Pagination handling
                document.querySelectorAll('.page-link').forEach(link => {
                    link.addEventListener('click', function (e) {
                        e.preventDefault();
                        if (this.parentElement.classList.contains('disabled') ||
                            this.parentElement.classList.contains('active') ||
                            this.textContent === '...') {
                            return;
                        }

                        const page = parseInt(this.getAttribute('data-page'));
                        if (isNaN(page)) return;

                        window.location.href = `/shop?${buildQueryString(page)}`;
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    });
                });

                // Cart handling
                function initializeCartButtons() {
                    const cartButtons = document.querySelectorAll('.add-to-cart');
                    const productIds = Array.from(cartButtons).map(btn => btn.getAttribute('data-product-id')).filter(Boolean);

                    if (productIds.length === 0) return;

                    fetch('/cart/status', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ productIds })
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                cartButtons.forEach(button => {
                                    const productId = button.getAttribute('data-product-id');
                                    if (data.cartStatus[productId]) {
                                        button.innerHTML = '<i class="fas fa-shopping-cart"></i> Go to Cart';
                                        button.classList.add('bg-black');

                                        const newButton = button.cloneNode(true);
                                        button.parentNode.replaceChild(newButton, button);

                                        newButton.addEventListener('click', () => {
                                            window.location.href = '/cart';
                                        });
                                    }
                                });
                            }
                        })
                        .catch(err => console.error('Cart status error:', err));
                }

                // Wishlist handling
                function initializeWishlistButtons() {
                    const wishlistButtons = document.querySelectorAll('.add-to-wishlist');
                    const productIds = Array.from(wishlistButtons).map(btn => btn.getAttribute('data-product-id')).filter(Boolean);
                    if (productIds.length === 0) return;

                    fetch('/wishlist/status', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ productIds: productIds })
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                wishlistButtons.forEach(button => {
                                    const productId = button.getAttribute('data-product-id');
                                    if (data.wishlistStatus[productId]) {
                                        button.innerHTML = '<i class="fas fa-heart"></i>';
                                        button.classList.add('active');
                                    } else {
                                        button.innerHTML = '<i class="far fa-heart"></i>';
                                        button.classList.remove('active');
                                    }
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching wishlist status:', error);
                            wishlistButtons.forEach(button => {
                                button.innerHTML = '<i class="far fa-heart"></i>';
                                button.classList.remove('active');
                            });
                        });
                }

                function addToCart(productId, button) {
                    if (!productId) {
                        showToast('Invalid product ID', 'error');
                        return;
                    }

                    fetch('/cart/add', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ productId, quantity: 1 })
                    })
                        .then(response => {
                            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                showToast('Product added to cart!', 'success');
                                updateCartCounter(data.cartCount);

                                window.updateCartBadge();

                                if (button) {
                                    button.innerHTML = '<i class="fas fa-shopping-cart"></i> Go to Cart';
                                    button.classList.add('bg-black');
                                    const newButton = button.cloneNode(true);
                                    button.parentNode.replaceChild(newButton, button);
                                    newButton.addEventListener('click', () => {
                                        window.location.href = '/cart';
                                    });
                                }
                            } else {
                                showToast(data.message || 'Failed to add product to cart', 'error');
                                if (data.message?.includes('login')) {
                                    setTimeout(() => window.location.href = '/login', 2000);
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Add to cart error:', error);
                            showToast('Please login & try again', 'error');
                            setTimeout(() => window.location.href = '/login', 2000);
                        });
                }

                function toggleWishlist(productId, button) {
                    if (!productId) {
                        showToast('Invalid product ID', 'error');
                        return;
                    }

                    button.disabled = true;
                    const originalHTML = button.innerHTML;
                    const wasActive = button.classList.contains('active');

                    if (wasActive) {
                        button.innerHTML = '<i class="far fa-heart"></i>';
                        button.classList.remove('active');
                    } else {
                        button.innerHTML = '<i class="fas fa-heart"></i>';
                        button.classList.add('active');
                    }

                    const url = wasActive ? `/wishlist/remove/${productId}` : '/addtowishlist';
                    const method = wasActive ? 'DELETE' : 'POST';

                    const fetchOptions = {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        ...(method === 'POST' && { body: JSON.stringify({ productId }) })
                    };

                    fetch(url, fetchOptions)
                        .then(response => {
                            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                updateWishlistCounter(data.wishlistCount);
                                window.updateWishlistBadge();

                            } else {
                                button.innerHTML = originalHTML;
                                if (wasActive) button.classList.add('active');
                                else button.classList.remove('active');
                                if (data.message?.includes('login')) {
                                    showToast('Please login to manage wishlist', 'error');
                                    setTimeout(() => window.location.href = '/login', 2000);
                                } else if (data.message?.includes('blocked')) {
                                    showToast('Your account is blocked', 'error');
                                    setTimeout(() => window.location.href = '/login', 2000);
                                } else {
                                    showToast(data.message || 'Wishlist update failed', 'error');
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            button.innerHTML = originalHTML;
                            if (wasActive) button.classList.add('active');
                            else button.classList.remove('active');
                            showToast('Please login & try again.', 'error');
                            if (error) {
                                setTimeout(() => window.location.href = '/login', 2000);
                            }
                        })
                        .finally(() => {
                            button.disabled = false;
                        });
                }

                // Add to cart
                const addToCartButtons = document.querySelectorAll('.add-to-cart');
                addToCartButtons.forEach(button => {
                    button.addEventListener('click', function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const productId = this.getAttribute('data-product-id');
                        addToCart(productId, this);
                    });
                });

                // Wishlist buttons
                const wishlistButtons = document.querySelectorAll('.add-to-wishlist');
                wishlistButtons.forEach(button => {
                    button.addEventListener('click', function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        if (this.disabled) return;
                        const productId = this.getAttribute('data-product-id');
                        toggleWishlist(productId, this);
                    });
                });
            });
        </script>
        <%- include("../../views/partials/user/footer") %>
</body>

</html>