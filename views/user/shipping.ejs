<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SHADES - Shipping Selection (Checkout Step 2)</title>
    <script defer src="/script/script.js"></script>
    <link rel="icon" href="/favicon-16x16.png" type="image/png">
  </head>

  <body
    style="
      background-color: #ffffff;
      min-height: 100vh;
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      display: flex;
      flex-direction: column;
    "
  >
    <%-include("../../views/partials/user/header")%>
    <div
      style="
        background-color: white;
        padding: 1.5rem;
        border-radius: 0.75rem;

        width: 100%;
        max-width: 64rem;
        margin: 1rem auto;
        flex: 1;
        margin-bottom: 10rem;
      "
    >
      <!-- Progress Indicator -->
      <div
        style="display: flex; justify-content: space-between; margin-bottom: 1.5rem; gap: 0.75rem"
      >
        <div style="display: flex; align-items: center; flex: 1; justify-content: center">
          <div
            style="
              width: 1.75rem;
              height: 1.75rem;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 0.875rem;
              font-weight: 600;
              transition: all 0.3s ease;
              background-color: #424242;
              color: white;
            "
            aria-label="Step 1: Address"
          >
            1
          </div>
          <span style="margin-left: 0.5rem; font-size: 0.875rem; font-weight: 500; color: #6b7280"
            >Address</span
          >
        </div>
        <div style="display: flex; align-items: center; flex: 1; justify-content: center">
          <div
            style="
              width: 1.75rem;
              height: 1.75rem;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 0.875rem;
              font-weight: 600;
              transition: all 0.3s ease;
              background-color: #000000;
              color: white;
            "
            aria-label="Step 2: Shipping"
          >
            2
          </div>
          <span style="margin-left: 0.5rem; font-size: 0.875rem; font-weight: 600; color: #000000"
            >Shipping</span
          >
        </div>
        <div style="display: flex; align-items: center; flex: 1; justify-content: center">
          <div
            style="
              width: 1.75rem;
              height: 1.75rem;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 0.875rem;
              font-weight: 600;
              transition: all 0.3s ease;
              background-color: #e5e7eb;
              color: #6b7280;
            "
            aria-label="Step 3: Payment"
          >
            3
          </div>
          <span style="margin-left: 0.5rem; font-size: 0.875rem; font-weight: 500; color: #6b7280"
            >Payment</span
          >
        </div>
      </div>

      <!-- Section: Shipping Method -->
      <div style="margin-bottom: 1.5rem">
        <h2 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; color: #1f2937">
          Shipping Method
        </h2>
        <div
          class="shipping-option"
          data-id="free"
          style="
            display: flex;
            align-items: center;
            background-color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
          "
        >
          <input
            type="radio"
            name="shippingMethod"
            id="freeShipping"
            value="free"
            checked
            style="margin-top: 0.25rem; accent-color: #000000"
            aria-label="Select Free Shipping"
          />
          <div style="margin-left: 0.75rem; flex: 1">
            <div style="display: flex; justify-content: space-between; align-items: center">
              <span style="font-weight: 600; font-size: 0.9375rem; color: #1f2937">Free</span>
              <% const shippingDate=new Date(); shippingDate.setDate(shippingDate.getDate() + 3); %>
              <span style="font-size: 0.875rem; color: #4b5563">
                <%= shippingDate.toLocaleDateString('en-US', { month: 'short' , day: 'numeric' ,
                year: 'numeric' }) %>
              </span>
            </div>
            <p style="color: #4b5563; font-size: 0.875rem; margin: 0.2rem 0">Regular shipping</p>
          </div>
        </div>
        <div
          class="shipping-option"
          data-id="schedule"
          style="
            display: flex;
            align-items: center;
            background-color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
          "
        >
          <input
            type="radio"
            name="shippingMethod"
            id="scheduleShipping"
            value="schedule"
            style="margin-top: 0.25rem; accent-color: #000000"
            aria-label="Select Schedule Shipping"
          />
          <div style="margin-left: 0.75rem; flex: 1">
            <div style="display: flex; justify-content: space-between; align-items: center">
              <span style="font-weight: 600; font-size: 0.9375rem; color: #1f2937">Schedule</span>
              <span id="scheduleDateDisplay" style="font-size: 0.875rem; color: #4b5563"></span>
            </div>
            <p style="color: #4b5563; font-size: 0.875rem; margin: 0.2rem 0">
              Pick a custom delivery date
            </p>
          </div>
        </div>
        <div id="datePickerSection" style="display: none; margin-top: 1rem">
          <label
            style="
              font-size: 0.875rem;
              font-weight: 500;
              color: #1f2937;
              margin-bottom: 0.25rem;
              display: block;
            "
            >Select Delivery Date</label
          >
          <input
            type="date"
            id="deliveryDate"
            style="
              width: 100%;
              max-width: 15rem;
              padding: 0.5rem;
              border: 1px solid #d1d5db;
              border-radius: 0.5rem;
              font-size: 0.9rem;
              transition: all 0.2s ease;
            "
            min=""
            max=""
            onfocus="this.style.borderColor='#000000'; this.style.boxShadow='0 0 0 3px rgba(0, 0, 0, 0.1)';"
            onblur="this.style.borderColor='#d1d5db'; this.style.boxShadow='none';"
          />
          <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem">
            Select a date after priority delivery within 7 days
          </p>
        </div>
      </div>

      <!-- Navigation Buttons -->
      <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem; justify-content: flex-end">
        <a href="select-address">
          <button
            style="
              width: 10rem;
              max-width: 100%;
              padding: 0.8rem 1rem;
              border-radius: 0.35rem;
              font-size: 0.9rem;
              cursor: pointer;
              transition: all 0.2s ease;
              border: 1px solid #ffffff;
              color: #ffffff;
              background-color: gray;
            "
            onmouseover="this.style.backgroundColor='#b1b1b1';"
            onmouseout="this.style.backgroundColor='gray';"
            aria-label="Back to address"
          >
            Back
          </button>
        </a>
        <button
          id="nextButton"
          style="
            width: 10rem;
            max-width: 100%;
            padding: 0.8rem 1rem;
            border-radius: 0.35rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #000000;
            color: white;
            border: none;
          "
          onmouseover="this.style.backgroundColor='#333333';"
          onmouseout="this.style.backgroundColor='#000000';"
          aria-label="Continue to payment"
        >
          Next
        </button>
      </div>
    </div>
    <%-include("../../views/partials/user/footer")%>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const today = new Date();
        const minDate = new Date(today);
        minDate.setDate(today.getDate() + 3);
        const maxDate = new Date(today);
        maxDate.setDate(today.getDate() + 7);

        const dateInput = document.getElementById('deliveryDate');
        const datePickerSection = document.getElementById('datePickerSection');
        const scheduleInput = document.getElementById('scheduleShipping');

        dateInput.min = minDate.toISOString().split('T')[0];
        dateInput.max = maxDate.toISOString().split('T')[0];
        dateInput.value = minDate.toISOString().split('T')[0];

        if (scheduleInput.checked) {
          datePickerSection.style.display = 'block';
        }

        // Display the correct formatted date on load
        updateScheduleDateDisplay(new Date(dateInput.value));

        // Toggle date picker visibility
        document.querySelectorAll('input[name="shippingMethod"]').forEach((input) => {
          input.addEventListener('change', function () {
            if (this.value === 'schedule') {
              datePickerSection.style.display = 'block';
              updateScheduleDateDisplay(new Date(dateInput.value)); // update again when switched
            } else {
              datePickerSection.style.display = 'none';
            }
          });
        });

        // Update when date manually changed
        dateInput.addEventListener('change', function () {
          const selectedDate = new Date(this.value);
          updateScheduleDateDisplay(selectedDate);
        });

        function updateScheduleDateDisplay(date) {
          const options = { month: 'short', day: 'numeric', year: 'numeric' };
          document.getElementById('scheduleDateDisplay').textContent = date.toLocaleDateString(
            'en-US',
            options
          );
        }
      });

      // Handle form submission to proceed to payment
      document.getElementById('nextButton').addEventListener('click', async function () {
        const selectedMethod = document.querySelector('input[name="shippingMethod"]:checked').value;
        let deliveryDate = null;

        if (selectedMethod === 'schedule') {
          deliveryDate = document.getElementById('deliveryDate').value;
          if (!deliveryDate) {
            showToast('Please select a delivery date.', 'error');
            return;
          }
        }

        const data = {
          shippingMethod: selectedMethod,
          deliveryDate: deliveryDate,
        };

        try {
          const response = await fetch('/checkout/proceed-to-payment', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
          });

          const result = await response.json();

          if (result.success) {
            window.location.href = result.redirectUrl;
          } else {
            showToast(result.message, 'error');
          }
        } catch (error) {
          console.error('Error:', error);
          showToast('Something went wrong. Please try again.', 'error');
        }
      });
      document.querySelectorAll('.shipping-option').forEach((option) => {
        option.addEventListener('click', function (e) {
          // Avoid selecting radio when clicking inside the date picker
          if (e.target.closest('#datePickerSection') || e.target.tagName === 'INPUT') return;

          const id = this.getAttribute('data-id');
          const radio = document.getElementById(`${id}Shipping`);
          if (radio) {
            radio.checked = true;

            // Show or hide date picker section
            if (id === 'schedule') {
              document.getElementById('datePickerSection').style.display = 'block';
            } else {
              document.getElementById('datePickerSection').style.display = 'none';
            }
          }
        });
      });

      // Show/hide the date picker if user selects radio directly
      document.getElementById('scheduleShipping').addEventListener('change', () => {
        document.getElementById('datePickerSection').style.display = 'block';
      });
      document.getElementById('freeShipping').addEventListener('change', () => {
        document.getElementById('datePickerSection').style.display = 'none';
      });
    </script>
  </body>
</html>
