<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SHADES - Admin Dashboard</title>
    <link rel="icon" href="/favicon-16x16.png" type="image/png">
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <script defer src="/admin.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'shades-black': '#111111',
              'shades-gray': '#F5F5F7',
            },
          },
        },
      };
    </script>
  </head>

  <body class="bg-shades-black">
    <%- include('../../views/partials/admin/header')%>
    <!-- Main Content -->
    <main class="flex-1 md:ml-64 transition-all duration-300">
      <!-- Top Header -->
      <header class="sticky top-0 z-40 bg-shades-black shadow-sm">
        
        <div class="flex justify-between items-center px-4 sm:px-6 py-4">
          <button id="mobile-menu-toggle" class="md:hidden text-gray-800 focus:outline-none">
            <i class="fas fa-bars text-xl"></i>
          </button>
          <h1 class="text-white font-medium">Admin Dashboard</h1>
        </div>
      </header>
      <div class="p-4 sm:p-6 max-w-[100vw] overflow-x-hidden">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6">
          <div class="bg-black rounded-lg shadow-sm p-4 sm:p-6 border-l-4 border-blue-500">
            <div class="flex justify-between items-center">
              <div>
                <p class="text-xs sm:text-sm font-medium text-gray-200">Total Revenue</p>
                <h3 class="text-xl sm:text-2xl font-bold text-white">
                  â‚¹<%=totalRevenue.toLocaleString('en-IN') %>
                </h3>
              </div>
              <div
                class="h-10 w-10 sm:h-12 sm:w-12 rounded-full bg-blue-100 flex items-center justify-center"
              >
                <i class="fas fa-dollar-sign text-blue-500"></i>
              </div>
            </div>
          </div>

          <div class="bg-black rounded-lg shadow-sm p-4 sm:p-6 border-l-4 border-purple-500">
            <div class="flex justify-between items-center">
              <div>
                <p class="text-xs sm:text-sm font-medium text-gray-200">Orders</p>
                <h3 class="text-xl sm:text-2xl font-bold text-white"><%=totalOrders%></h3>
              </div>
              <div
                class="h-10 w-10 sm:h-12 sm:w-12 rounded-full bg-purple-100 flex items-center justify-center"
              >
                <i class="fas fa-shopping-bag text-purple-500"></i>
              </div>
            </div>
          </div>

          <div class="bg-black rounded-lg shadow-sm p-4 sm:p-6 border-l-4 border-green-500">
            <div class="flex justify-between items-center">
              <div>
                <p class="text-xs sm:text-sm font-medium text-gray-200">Customers</p>
                <h3 class="text-xl sm:text-2xl font-bold text-white"><%=totalCustomers%></h3>
              </div>
              <div
                class="h-10 w-10 sm:h-12 sm:w-12 rounded-full bg-green-100 flex items-center justify-center"
              >
                <i class="fas fa-users text-green-500"></i>
              </div>
            </div>
          </div>

          <div class="bg-black rounded-lg shadow-sm p-4 sm:p-6 border-l-4 border-yellow-500">
            <div class="flex justify-between items-center">
              <div>
                <p class="text-xs sm:text-sm font-medium text-gray-200">Products</p>
                <h3 class="text-xl sm:text-2xl font-bold text-white"><%=totalProducts%></h3>
              </div>
              <div
                class="h-10 w-10 sm:h-12 sm:w-12 rounded-full bg-yellow-100 flex items-center justify-center"
              >
                <i class="fas fa-box text-yellow-500"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
          <!-- Sales Overview -->
          <div class="bg-black rounded-lg shadow-sm p-4 sm:p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-base sm:text-lg font-semibold text-white">Sales Overview</h3>
              <select
                id="chartFilter"
                class="text-xs text-white bg-black sm:text-sm border border-black rounded px-2 py-1 focus:outline-none"
              >
                <option value="daily">Daily</option>
                <option value="weekly" selected>Weekly</option>
                <option value="monthly">Monthly</option>
                <option value="yearly">Yearly</option>
              </select>
            </div>
            <canvas id="salesChart" class="w-full" style="max-height: 350px"></canvas>
          </div>

          <!-- Top Selling Pie Chart -->
          <div class="bg-black rounded-lg shadow-sm p-4 sm:p-6 mb-6 min-h-[350px] sm:min-h-[450px]">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-base sm:text-lg font-semibold">Top Selling Overview</h3>
              <select
                id="topFilter"
                class="text-xs sm:text-sm border text-white bg-black border-black rounded px-2 py-1 focus:outline-none"
              >
                <option value="product">Products</option>
                <option value="category">Categories</option>
                <option value="brand">Brands</option>
              </select>
            </div>
            <canvas id="topSalesChart" class="w-full" style="max-height: 350px"></canvas>
          </div>
        </div>

        <!-- Stock Status -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
          <!-- Out of Stock -->
          <div
            class="flex justify-between items-center bg-black shadow-sm p-4 sm:p-6 rounded-lg mb-6"
          >
            <div>
              <p class="text-xs sm:text-sm font-semibold text-red-600 uppercase tracking-wide">
                Out of Stock
              </p>
              <% if (outOfStock> 0) { %>
              <h3 class="text-2xl sm:text-3xl font-bold text-gray-800">
                <%= outOfStock %> product<%= outOfStock> 1 ? 's' : '' %>
              </h3>
              <p class="text-xs text-red-500 mt-1 flex items-center">
                <i class="fas fa-exclamation-circle mr-1"></i> Needs restocking
              </p>
              <% } else { %>
              <p class="text-sm text-green-500 mt-1 flex items-center">
                <i class="fas fa-check-circle mr-1"></i> Stock level is healthy
              </p>
              <% } %>
            </div>
            <div
              class="h-12 w-12 sm:h-16 sm:w-16 rounded-full bg-red-100 flex items-center justify-center"
            >
              <i class="fas fa-box-open text-red-500 text-lg sm:text-xl"></i>
            </div>
          </div>

          <!-- Low in Stock -->
          <div
            class="flex justify-between items-center bg-black shadow-sm p-4 sm:p-6 rounded-lg mb-6"
          >
            <div>
              <p class="text-xs sm:text-sm font-semibold text-yellow-500 uppercase tracking-wide">
                Low in Stock
              </p>
              <% if (lowStock> 0) { %>
              <h3 class="text-2xl sm:text-3xl font-bold text-gray-800">
                <%= lowStock %> product<%= lowStock> 1 ? 's' : '' %>
              </h3>
              <p class="text-xs text-yellow-500 mt-1 flex items-center">
                <i class="fas fa-exclamation-triangle mr-1"></i> Consider restocking soon
              </p>
              <% } else { %>
              <p class="text-sm text-green-500 mt-1 flex items-center">
                <i class="fas fa-check-circle mr-1"></i> Stock level is healthy
              </p>
              <% } %>
            </div>
            <div
              class="h-12 w-12 sm:h-16 sm:w-16 rounded-full bg-yellow-100 flex items-center justify-center"
            >
              <i class="fas fa-boxes text-yellow-500 text-lg sm:text-xl"></i>
            </div>
          </div>

          <!-- In Stock -->
          <div
            class="flex justify-between items-center bg-black shadow-sm p-4 sm:p-6 rounded-lg mb-6"
          >
            <div>
              <p class="text-xs sm:text-sm font-semibold text-green-600 uppercase tracking-wide">
                In Stock
              </p>
              <% if (inStock> 0) { %>
              <h3 class="text-2xl sm:text-3xl font-bold text-gray-200">
                <%= inStock %> product<%= inStock> 1 ? 's' : '' %>
              </h3>
              <p class="text-xs text-green-500 mt-1 flex items-center">
                <i class="fas fa-check-circle mr-1"></i> Stock level is healthy
              </p>
              <% } else { %>
              <h3 class="text-base sm:text-xl font-semibold text-red-500 mt-2">
                No products in stock
              </h3>
              <% } %>
            </div>
            <div
              class="h-12 w-12 sm:h-16 sm:w-16 rounded-full bg-green-100 flex items-center justify-center"
            >
              <i class="fas fa-warehouse text-green-600 text-lg sm:text-xl"></i>
            </div>
          </div>
        </div>

        <!-- Recent Orders Table -->
        <div class="bg-black rounded-lg shadow-sm overflow-hidden mb-6">
          <div class="px-4 sm:px-6 py-4 flex justify-between items-center border-b border-gray-200">
            <h3 class="text-base sm:text-lg font-semibold text-white">Recent Orders</h3>
            <a href="/admin/orders">
              <button class="text-xs sm:text-sm text-gray-300 hover:text-white transition ease-in">View All</button>
            </a>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    scope="col"
                    class="px-4 sm:px-6 py-3 text-left text-xs font-medium bg-gray-950 text-gray-200 uppercase tracking-wider"
                  >
                    Order ID
                  </th>
                  <th
                    scope="col"
                    class="px-4 sm:px-6 py-3 text-left text-xs font-medium bg-gray-950 text-gray-200 uppercase tracking-wider"
                  >
                    Customer
                  </th>
                  <th
                    scope="col"
                    class="px-4 sm:px-6 py-3 text-left text-xs font-medium bg-gray-950 text-gray-200 uppercase tracking-wider hidden sm:table-cell"
                  >
                    Date
                  </th>
                  <th
                    scope="col"
                    class="px-4 sm:px-6 py-3 text-left text-xs font-medium bg-gray-950 text-gray-200 uppercase tracking-wider hidden md:table-cell"
                  >
                    Total
                  </th>
                  <th
                    scope="col"
                    class="px-4 sm:px-6 py-3 text-center text-xs font-medium bg-gray-950 text-gray-200 uppercase tracking-wider hidden lg:table-cell"
                  >
                    Status
                  </th>
                  
                </tr>
              </thead>
              <tbody class="bg-black divide-y divide-gray-200">
                <% orders.forEach(order=> { %>
                <tr class="hover:bg-gray-950">
                  <td class="px-4 sm:px-6 py-4 whitespace-nowrap">
                    <div class="text-xs sm:text-sm font-medium text-gray-200">
                      #<%= order.orderId %>
                    </div>
                  </td>
                  <td class="px-4 sm:px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                      <div
                        class="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center"
                      >
                        <span class="text-xs font-medium">
                          <%= order.userId?.name?.split(' ').map(n => n[0]).join('').toUpperCase()
                          %>
                        </span>
                      </div>
                      <div class="ml-3">
                        <div class="text-xs sm:text-sm font-medium text-gray-200">
                          <%= order.userId?.name || ' Unknown' %>
                        </div>
                        <div class="text-xs text-gray-500"><%= order.userId?.email || 'N/A' %></div>
                      </div>
                    </div>
                  </td>
                  <td class="px-4 sm:px-6 py-4 whitespace-nowrap hidden sm:table-cell">
                    <div class="text-xs sm:text-sm text-gray-200">
                      <%= new Date(order.createdAt).toLocaleDateString('en-GB') %>
                    </div>
                  </td>
                  <td class="px-4 sm:px-6 py-4 whitespace-nowrap hidden md:table-cell">
                    <div class="text-xs sm:text-sm font-medium text-gray-200">
                      â‚¹<%= order.finalAmount %>
                    </div>
                  </td>
                  <td class="px-4 sm:px-6 text-center py-4 whitespace-nowrap hidden lg:table-cell">
                    <% if(order.status==='delivered' ) { %>
                    <span
                      class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800"
                    >
                      <%= order.status %>
                    </span>
                    <% } else if(order.status==='cancelled' ) { %>
                    <span
                      class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800"
                    >
                      <%= order.status %>
                    </span>
                    <% } else if(order.status==='shipped' ) { %>
                    <span
                      class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800"
                    >
                      <%= order.status %>
                    </span>
                    <% } else if(order.status==='return_request' ) { %>
                    <span
                      class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800"
                    >
                      <%= order.status %>
                    </span>
                    <% } else if(order.status==='returned' ) { %>
                    <span
                      class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-200 text-gray-800"
                    >
                      <%= order.status %>
                    </span>
                    <% } else if(order.status==='confirmed' ) { %>
                    <span
                      class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800"
                    >
                      <%= order.status %>
                    </span>
                    <% } else { %>
                    <span
                      class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800"
                    >
                      <%= order.status %>
                    </span>
                    <% } %>
                  </td>
                 
                </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Activity & Popular Products -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
          <div class="bg-black rounded-lg shadow-sm p-4 sm:p-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-base sm:text-lg font-semibold text-white">Recent Activity</h3>
              <a
                href="/admin/all-recent-activities"
                class="text-xs sm:text-sm text-gray-300 hover:text-white transition ease-in"
                >View All</a
              >
            </div>
            <div class="space-y-4 max-h-[300px] overflow-y-auto">
              <% recentActivities.forEach(activity=> { %>
              <% if (activity.type==='user' ) { %>
              <div class="flex">
                <div class="flex-shrink-0 mr-3">
                  <div class="h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center">
                    <i class="fas fa-user-plus text-blue-500 text-sm"></i>
                  </div>
                </div>
                <div>
                  <p class="text-xs sm:text-sm font-medium text-white">
                    New customer <%= activity.name %> registered
                  </p>
                  <p class="text-xs text-gray-300">
                    <%= new Date(activity.time).toLocaleDateString('en-IN') %>, <%= new
                    Date(activity.time).toLocaleTimeString('en-IN', { hour: '2-digit' , minute:
                    '2-digit' }) %>
                  </p>
                </div>
              </div>
              <% } else if (activity.type==='order' ) { %>
              <div class="flex">
                <div class="flex-shrink-0 mr-3">
                  <div class="h-8 w-8 rounded-full bg-green-100 flex items-center justify-center">
                    <i class="fas fa-dollar-sign text-green-500 text-sm"></i>
                  </div>
                </div>
                <div>
                  <p class="text-xs sm:text-sm font-medium text-white">
                    New order <%= activity.orderId %> received
                  </p>
                  <p class="text-xs text-gray-300">
                    <%= new Date(activity.time).toLocaleDateString('en-IN') %>, <%= new
                    Date(activity.time).toLocaleTimeString('en-IN', { hour: '2-digit' , minute:
                    '2-digit' }) %>
                  </p>
                </div>
              </div>
              <% } else if (activity.type==='outOfStock' ) { %>
              <div class="flex">
                <div class="flex-shrink-0 mr-3">
                  <div class="h-8 w-8 rounded-full bg-yellow-100 flex items-center justify-center">
                    <i class="fas fa-box text-red-500 text-sm"></i>
                  </div>
                </div>
                <div>
                  <p class="text-xs sm:text-sm font-medium text-white">
                    Product "<%= activity.productName %>" out of stock
                  </p>
                  <p class="text-xs text-gray-300">Needs restocking</p>
                </div>
              </div>
              <% } else if (activity.type==='lowStock' ) { %>
              <div class="flex">
                <div class="flex-shrink-0 mr-3">
                  <div class="h-8 w-8 rounded-full bg-yellow-100 flex items-center justify-center">
                    <i class="fas fa-box text-yellow-500 text-sm"></i>
                  </div>
                </div>
                <div>
                  <p class="text-xs sm:text-sm font-medium text-white">
                    Product "<%= activity.productName %>" stock low
                  </p>
                  <p class="text-xs text-gray-300">Only <%= activity.quantity %> left</p>
                </div>
              </div>
              <% } else if (activity.type==='stockAdded' ) { %>
              <div class="flex">
                <div class="flex-shrink-0 mr-3">
                  <div class="h-8 w-8 rounded-full bg-green-100 flex items-center justify-center">
                    <i class="fas fa-warehouse text-green-600 text-sm"></i>
                  </div>
                </div>
                <div>
                  <p class="text-xs sm:text-sm font-medium text-white">
                    Product "<%= activity.productName %>" stock added
                  </p>
                  <p class="text-xs text-gray-300">Added <%= activity.quantity %> stock</p>
                </div>
              </div>
              <% } else if (activity.type==='coupon' ) { %>
              <div class="flex">
                <div class="flex-shrink-0 mr-3">
                  <div class="h-8 w-8 rounded-full bg-purple-100 flex items-center justify-center">
                    <i class="fas fa-tag text-purple-500 text-sm"></i>
                  </div>
                </div>
                <div>
                  <p class="text-xs sm:text-sm font-medium text-white">
                    New coupon "<%= activity.name %>" created
                  </p>
                  <p class="text-xs text-gray-300">
                    <%= new Date(activity.time).toLocaleDateString('en-IN') %>, <%= new
                    Date(activity.time).toLocaleTimeString('en-IN', { hour: '2-digit' , minute:
                    '2-digit' }) %>
                  </p>
                </div>
              </div>
              <% } %>
              <% }) %>
            </div>
          </div>

          <div class="bg-black rounded-lg shadow-sm p-4 sm:p-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-base sm:text-lg font-semibold text-white">Top Products</h3>
              <a href="/admin/products" class="text-xs sm:text-sm text-gray-300 hover:text-white transition ease-in"
                >View All</a
              >
            </div>
            <% if (topProducts.length===0) { %>
            <p class="text-xs sm:text-sm text-gray-300">No products found.</p>
            <% } else { %>
            <div class="space-y-4 max-h-[300px] overflow-y-auto">
              <% topProducts.forEach(product=> { %>
              <div class="flex items-center">
                <div class="h-8 w-16 bg-gray-100 rounded flex items-center justify-center mr-3">
                  <% if (product.productImage && product.productImage.length> 0) { %>
                  <img
                    src="<%= product.productImage[0] %>"
                    alt="Product Image"
                    class="h-10 w-16 rounded object-contain"
                  />
                  <% } else { %>
                  <i class="fas fa-box text-gray-300"></i>
                  <% } %>
                </div>
                <div class="flex-1">
                  <h4 class="text-xs sm:text-sm font-medium text-white"><%= product.productName %></h4>
                  <p class="text-xs text-gray-300"><%= product.salesCount %> sold</p>
                </div>
                <div class="text-xs sm:text-sm font-medium">
                  â‚¹<%= product.salePrice.toFixed(2) %>
                </div>
              </div>
              <% }) %>
            </div>
            <% } %>
          </div>
        </div>

        <!-- Order Modal -->
        <div
          id="orderModal"
          class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50"
        >
          <div
            class="bg-white rounded-lg p-4 sm:p-6 w-full max-w-[95vw] sm:max-w-2xl max-h-[90vh] overflow-y-auto"
          >
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-base sm:text-lg font-semibold">Order Details</h3>
              <button id="closeModal" class="text-gray-500 hover:text-black">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div id="orderDetailsContent">
              <!-- Order details will be populated here -->
            </div>
          </div>
        </div>
      </div>
      <div class="p-4 sm:p-6"></div>
    </main>
    <%- include('../../views/partials/admin/footer')%>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const topCtx = document.getElementById('topSalesChart').getContext('2d');
      let topChart = null;

      async function fetchTopSalesData(filter = 'product') {
        try {
          const res = await fetch(`/admin/top-sales-chart?filter=${filter}`);
          const result = await res.json();
          if (!result.success) return;

          const labels = result.data.map((item) => item.name);
          const values = result.data.map((item) => item.totalSold);

          if (topChart) topChart.destroy();

          topChart = new Chart(topCtx, {
            type: 'pie',
            data: {
              labels: labels,
              datasets: [
                {
                  data: values,
                  backgroundColor: [
                    '#EF4444',
                    '#F97316',
                    '#FACC15',
                    '#22C55E',
                    '#3B82F6',
                    '#6366F1',
                    '#8B5CF6',
                    '#EC4899',
                    '#14B8A6',
                    '#EAB308',
                  ],
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom',
                  labels: {
                    font: {
                      size: window.innerWidth < 640 ? 12 : 14,
                    },
                  },
                },
                tooltip: {
                  callbacks: {
                    label: function (ctx) {
                      const label = ctx.label || '';
                      const value = ctx.formattedValue || 0;
                      return `${label}: ${value} sold`;
                    },
                  },
                },
              },
            },
          });
        } catch (error) {
          console.error('Failed to load top sales chart:', error);
        }
      }

      document.getElementById('topFilter').addEventListener('change', function () {
        fetchTopSalesData(this.value);
      });

      // Initial load
      fetchTopSalesData('product');

      const ctx = document.getElementById('salesChart').getContext('2d');
      let salesChart;

      async function fetchAndRenderChart(filter = 'weekly') {
        const response = await fetch(`/admin/sales-chart?filter=${filter}`);
        const result = await response.json();

        if (!result.success) return;

        const labels = result.data.map((item) => item._id);
        const values = result.data.map((item) => item.total);

        if (salesChart) salesChart.destroy();

        salesChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              {
                label: 'Sales (â‚¹)',
                data: values,
                fill: true,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                tension: 0.3,
                pointBackgroundColor: '#3b82f6',
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                labels: {
                  font: {
                    size: window.innerWidth < 640 ? 10 : 12,
                  },
                },
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1000,
                  font: {
                    size: window.innerWidth < 640 ? 10 : 12,
                  },
                },
              },
              x: {
                ticks: {
                  font: {
                    size: window.innerWidth < 640 ? 10 : 12,
                  },
                },
              },
            },
          },
        });
      }

      document.getElementById('chartFilter').addEventListener('change', function () {
        fetchAndRenderChart(this.value);
      });

      fetchAndRenderChart('weekly');

      document.querySelectorAll('.view-order').forEach((button) => {
        button.addEventListener('click', async (e) => {
          e.preventDefault();
          const orderId = e.target.closest('a').href.split('/').pop();
          try {
            const response = await fetch(`/admin/order/${orderId}`);
            const data = await response.json();

            if (response.ok && data.success) {
              const order = data.order;
              const modal = document.getElementById('orderModal');
              const content = document.getElementById('orderDetailsContent');

              function getStatusBadge(status) {
                const statusStyles = {
                  pending: 'bg-yellow-100 text-yellow-800',
                  confirmed: 'bg-blue-100 text-blue-800',
                  shipped: 'bg-purple-100 text-purple-800',
                  delivered: 'bg-green-100 text-green-800',
                  cancelled: 'bg-red-100 text-red-800',
                  return_requested: 'bg-orange-100 text-orange-800',
                  returned: 'bg-gray-100 text-gray-800',
                };

                const style = statusStyles[status] || 'bg-gray-100 text-gray-800';
                return `<span class="px-2 py-1 text-xs font-semibold rounded-full ${style}">${status.charAt(0).toUpperCase() + status.slice(1).replace('_', ' ')}</span>`;
              }

              content.innerHTML = `
            <div class="max-h-[70vh] overflow-y-auto">
              <h4 class="text-sm sm:text-md font-medium mb-4">Order #${order.orderId}</h4>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <div>
                  <p class="text-xs sm:text-sm"><strong>Customer:</strong> ${order.userId?.name || 'Unknown'}</p>
                  <p class="text-xs sm:text-sm"><strong>Email:</strong> ${order.userId?.email || 'N/A'}</p>
                </div>
                <div>
                  <p class="text-xs sm:text-sm"><strong>Date:</strong> ${new Date(order.createdAt).toLocaleDateString('en-GB')}</p>
                  <p class="text-xs sm:text-sm"><strong>Overall Status:</strong> ${getStatusBadge(order.status)}</p>
                </div>
              </div>
              <div class="mb-4 p-3 bg-gray-50 rounded">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                  <span class="text-xs sm:text-sm"><strong>Total Amount:</strong> â‚¹${order.finalAmount}</span>
                  <span class="text-xs sm:text-sm"><strong>Payment Method:</strong> ${order.paymentMethod?.toUpperCase()}</span>
                </div>
              </div>
              ${
                order.cancelReason
                  ? `
                <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded">
                  <p class="text-xs sm:text-sm"><strong>Cancellation Reason:</strong> ${order.cancelReason}</p>
                  ${order.cancelledAt ? `<p class="text-xs text-gray-600 mt-1">Cancelled on: ${new Date(order.cancelledAt).toLocaleDateString('en-GB')}</p>` : ''}
                </div>
              `
                  : ''
              }
              ${
                order.returnReason
                  ? `
                <div class="mb-4 p-3 bg-orange-50 border border-orange-200 rounded">
                  <p class="text-xs sm:text-sm"><strong>Return Reason:</strong> ${order.returnReason}</p>
                  ${order.returnDescription ? `<p class="text-xs sm:text-sm mt-1"><strong>Description:</strong> ${order.returnDescription}</p>` : ''}
                </div>
              `
                  : ''
              }
              <h5 class="text-xs sm:text-sm font-semibold mb-3">Order Items:</h5>
              <div class="space-y-3">
                ${
                  order.orderedItems
                    ?.map((item) => {
                      const itemStatus = item.status || order.status;
                      const isItemCancelled = itemStatus === 'cancelled';
                      return `
                    <div class="border rounded-lg p-3 ${isItemCancelled ? 'bg-red-50 border-red-200' : 'bg-white border-gray-200'}">
                      <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                          <h6 class="font-medium text-xs sm:text-sm ${isItemCancelled ? 'text-red-700 line-through' : 'text-gray-900'}">${item.productName || 'Unknown Product'}</h6>
                          <div class="mt-1 text-xs text-gray-600">
                            <span>Qty: ${item.quantity}</span> â€¢ 
                            <span>Price: â‚¹${item.price}</span> â€¢ 
                            <span>Total: â‚¹${item.price * item.quantity}</span>
                          </div>
                        </div>
                      </div>
                      ${
                        item.cancelReason
                          ? `
                        <div class="mt-2 p-2 bg-red-100 rounded text-xs">
                          <strong>Cancellation Reason:</strong> ${item.cancelReason}
                        </div>
                      `
                          : ''
                      }
                      ${
                        isItemCancelled
                          ? `
                        <div class="mt-2 text-xs text-red-600 font-medium">
                          <i class="fas fa-exclamation-triangle mr-1"></i>
                          This item has been cancelled
                        </div>
                      `
                          : ''
                      }
                    </div>
                  `;
                    })
                    .join('') || '<p class="text-gray-500 text-xs sm:text-sm">No items found</p>'
                }
              </div>
              <div class="mt-4 pt-4 border-t border-gray-200">
                <div class="space-y-1 text-xs sm:text-sm">
                  <div class="flex justify-between">
                    <span>Subtotal:</span>
                    <span>â‚¹${order.totalPrice}</span>
                  </div>
                  ${
                    order.discount > 0
                      ? `
                    <div class="flex justify-between text-green-600">
                      <span>Discount:</span>
                      <span>-â‚¹${order.discount}</span>
                    </div>
                  `
                      : ''
                  }
                  <div class="flex justify-between">
                    <span>GST:</span>
                    <span>â‚¹${order.gstAmount || 0}</span>
                  </div>
                  <div class="flex justify-between">
                    <span>Delivery Charge:</span>
                    <span>â‚¹${order.deliveryCharge}</span>
                  </div>
                  <div class="flex justify-between font-semibold text-sm sm:text-base pt-2 border-t">
                    <span>Final Amount:</span>
                    <span>â‚¹${order.finalAmount}</span>
                  </div>
                </div>
              </div>
              ${
                order.address
                  ? `
                <div class="mt-4 pt-4 border-t border-gray-200">
                  <h6 class="font-semibold text-xs sm:text-sm mb-2">Delivery Address:</h6>
                  <div class="text-xs sm:text-sm text-gray-700 bg-gray-50 p-3 rounded">
                    <p>${order.address.name || ''}</p>
                    <p>${order.address.houseName || ''}, ${order.address.street || ''}</p>
                    <p>${order.address.city || ''}, ${order.address.state || ''} - ${order.address.pincode || ''}</p>
                    ${order.address.phone ? `<p>Phone: ${order.address.phone}</p>` : ''}
                  </div>
                </div>
              `
                  : ''
              }
            </div>
          `;
              modal.classList.remove('hidden');
            } else {
              showToast('Failed to load order details', 'error');
            }
          } catch (error) {
            console.error('Error fetching order details:', error);
            showToast('An error occurred while loading order details', 'error');
          }
        });
      });

      document.getElementById('closeModal').addEventListener('click', () => {
        document.getElementById('orderModal').classList.add('hidden');
      });

      document.getElementById('orderModal').addEventListener('click', (e) => {
        if (e.target.id === 'orderModal') {
          document.getElementById('orderModal').classList.add('hidden');
        }
      });

      // Update chart font sizes on resize
      window.addEventListener('resize', () => {
        if (salesChart) {
          salesChart.options.scales.y.ticks.font.size = window.innerWidth < 640 ? 10 : 12;
          salesChart.options.scales.x.ticks.font.size = window.innerWidth < 640 ? 10 : 12;
          salesChart.options.plugins.legend.labels.font.size = window.innerWidth < 640 ? 10 : 12;
          salesChart.update();
        }
        if (topChart) {
          topChart.options.plugins.legend.labels.font.size = window.innerWidth < 640 ? 12 : 14;
          topChart.update();
        }
      });
    </script>
  </body>
</html>
